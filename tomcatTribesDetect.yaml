id: tomcat-tribes-fingerprint

info:
  name: Apache Tomcat Tribes - Definitive Fingerprint
  author: n0ur5

  severity: high
  description: |
    Definitively fingerprints Apache Tomcat Tribes cluster receiver by sending
    a valid Tribes packet with USE_ACK option and checking for the ACK response.

    This is NOT a false-positive prone port check - it validates the actual
    Tribes protocol by triggering an ACK response that only Tribes will send.

    ACK Response: FLT2002 + 00000003 + 060203 + TLF2003 (21 bytes)
  reference:
    - https://tomcat.apache.org/tomcat-9.0-doc/cluster-howto.html
  tags: tomcat,tribes,cluster,fingerprint,network
  metadata:
    verified: true
    product: apache-tomcat

network:
  - inputs:
      # Valid Tribes ChannelData with USE_ACK option (0x0002)
      # Triggers ACK response from real Tribes receivers
      - data: "464c54323030320000007f000000020000019be20189fa0000001001010101010101010101010101010101000000525452494245532d4201000000003a00000000000003e800000fa000000000ffffffff093132372e302e302e31000000000000000000000000000000000000000000000000000000005452494245532d45010000000005aced000570544c4632303033"
        type: hex

    host:
      - "{{Host}}:4000"
      - "{{Host}}:4001"
      - "{{Host}}:4002"
      - "{{Host}}:4003"

    read-size: 64

    matchers:
      # Match exact ACK response: FLT2002 + size(3) + ACK_DATA(060203) + TLF2003
      - type: binary
        binary:
          - "464c543230303200000003060203544c4632303033"

    extractors:
      - type: dsl
        name: tribes-confirmed
        dsl:
          - '"CONFIRMED Tribes at " + host'
